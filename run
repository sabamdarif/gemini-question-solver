#!/bin/bash

# Get timestamp function
get_timestamp() {
	date "+%Y-%m-%d %H:%M:%S %z"
}

# Get PID
PID=$$

print_success() {
	echo "[$(get_timestamp)] [$PID] [INFO] $1"
}

print_failed() {
	echo "[$(get_timestamp)] [$PID] [ERROR] $1"
}

print_warn() {
	echo "[$(get_timestamp)] [$PID] [WARNING] $1"
}

print_msg() {
	echo "[$(get_timestamp)] [$PID] [INFO] $1"
}

# Check Python
print_msg "Checking Python..."
if command -v python3 &>/dev/null; then
	print_success "Python3 found"
	PIP="pip3"
else
	print_failed "Python not installed"
	print_warn "Please install python first"
	exit 1
fi

# Check main.py
print_msg "Checking main.py..."
if [ -f "main.py" ]; then
	print_success "main.py found"
else
	print_failed "main.py not found"
	exit 1
fi

# Check requirements.txt
print_msg "Checking requirements.txt..."
if [ -f "requirements.txt" ]; then
	print_success "requirements.txt found"
	print_msg "Installing requirements..."
	if $PIP install -r requirements.txt -q; then
		print_success "Requirements installed"
	else
		print_failed "Failed to install requirements"
		exit 1
	fi
else
	print_warn "requirements.txt not found, skipping"
fi

# Check gunicorn
print_msg "Checking Gunicorn..."
if ! command -v gunicorn &>/dev/null; then
	print_warn "Gunicorn not found, installing..."
	if $PIP install gunicorn -q; then
		print_success "Gunicorn installed"
	else
		print_failed "Failed to install Gunicorn"
		exit 1
	fi
else
	print_success "Gunicorn found"
fi

# Launch app with Gunicorn
print_msg "Launching Website"
gunicorn main:app \
	--bind 0.0.0.0:5000 \
	--workers 2 \
	--threads 4 \
	--timeout 120
